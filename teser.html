<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hypergeometry</title>
    <script>
        codes = [`
// you can add extra parameters to the list of sliders like this

//        parameter name    display function            min   max  default  step
params = {'saturation':     [v => "Saturation: " + v,   1,    10,  3,       1]}


// r generates the points of a hypercube
let q = (v, l) => l.map((i) => i.concat([v]))
let r = (n, l) => n ? r(n - 1, q(-1, l).concat(q(1, l))) : l
points = r(paramValues.dim, [[]]);


// function to rotate bits
function shl(x, highBit) {
    let b = x & 1;
    x >>= 1;
    if (b)
        x += points.length / 2;
    return x;
}


// edges contains indices into points
edges = [];
for (let i = 0; i < points.length / 2; ++i) {
    let x = i * 2;
    let y = x + 1;
    for (let d = 0; d < paramValues.dim; d++) {
        let p = [x, y];
        p = p.concat(hsv2rgb((d / paramValues.dim + 12) * 360, 0.3, 1));
        edges.push(p);
        x = shl(x); y = shl(y);
    }
}`,
            "jchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEVjchv abjvcbajuvAJU\nGEVFUJfwmkahDBKJHSCXBJUBUjbvqwuvWDEJVJ\nWQEV"]
        let points = [];
        let edges = [];
        function hsv2rgb(h, s, v) {
            function f(n) {
                let k = (n + h / 60) % 6;
                return v - v * s * Math.max(Math.min(k, 4 - k, 1), 0);
            }
            return [Math.floor(f(5) * 256), Math.floor(f(3) * 256), Math.floor(f(1) * 256)];
        }
    </script>
    <style>
        html {
            --border: #87FFDD;
            --borderWidth: 1px;
            --control: #87E4FF;
            --editBorder: #87ffb5;
            --editbg: #171717;
            --editfg: #ffe5e5;
            --controlBackground: #FFFFFF;
            --errorColor: #FF0000;
            --bg: #000000;
            --fg: #FFFFFF;

            background-color: var(--bg);
            color: var(--fg);
            font-family: sans-serif;
        }

        .slider {
            -webkit-appearance: none;
            -webkit-transition: .2s;
            appearance: none;
            height: 0.75em;
            background: var(--controlBackground);
            outline: none;
            opacity: 0.8;
            transition: opacity .05s;
            display: inline;
            float: right;
            width: 60%;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25em;
            height: 1.25em;
            background: var(--control);
            transition: background-color 0.05s;
            border-width: 0px;
            cursor: pointer;
            outline: none;
        }

        .slider::-moz-range-thumb {
            width: 1.5em;
            height: 1.5em;
            background: var(--control);
            transition: background-color 0.05s;
            cursor: pointer;
            outline: none;
        }

        .slider::-moz-range-thumb:hover {
            background: #ffffff;
        }

        .control {
            padding-bottom: 1em;
            font-weight: bolder;
            border: 0%;
        }

        #panel {
            border-style: solid;
            border-width: var(--borderWidth);
            border-color: var(--border);
            box-sizing: border-box;
            padding: 0.5em;
            float: right;
            flex-flow: column;
            display: flex;
        }

        #c {
            border-style: solid;
            border-width: var(--borderWidth);
            border-color: var(--border);
            box-sizing: border-box;
            display: inline-block;
            float: left;

        }

        #editDiv {}

        #edit {
            resize: none;
            box-sizing: border-box;
            width: 100%;
            margin-top: 1em;
            background-color: var(--editbg);
            color: var(--editfg);
            flex: 1 1 auto;
            font-family: monospace;
        }

        select {
            color: var(--fg);
            background-color: var(--bg);
        }

        #message {
            font-family: monospaced;

        }

        .errord {
            color: var(--errorColor);
            font-weight: bold;

        }
    </style>
</head>

<body>

    <canvas id="c" width="100%" height="100%"></canvas>
    <div id="panel"></div>
    <script>
        const startDim = 4;
        let axesCombos = [];
        let rotations = [];
        let axesIndices = [];
        function incAxes() {
            upd("rotAxes", (paramValues.rotAxes + 1) % (parseFloat(document.getElementById("rotAxes").max) + 1) + "");
        }
        function redim(v) {
            let combine = (a) => a.flatMap((e, i) => a.filter((f, j) => j > i).map(g => [e, g]));
            axes = combine([...Array(v).keys()]);
            axesCombos = combine(axes);
            axesIndices = combine([...axes.keys()]);
            while (rotations.length < axes.length)
                rotations.push(0);
            while (rotations.length > axes.length)
                rotations.pop();
            if (document.getElementById("rotAxes")) {
                document.getElementById("rotAxes").max = axesCombos.length - 1;
                upd("rotAxes", 0);
            }
            if (document.getElementById("message"))
                run();
        }
        function axisname(x) {

            if (paramValues.dim == 2) {
                return "xy";
            } else {
                const axisString = "xyzwuvtsrqponmlkjihgfedcba";
                return axisString.substr(axesCombos[x][0][0], 1) + axisString.substr(axesCombos[x][0][1], 1) + "," + axisString.substr(axesCombos[x][1][0], 1) + axisString.substr(axesCombos[x][1][1], 1);
            }
        }
        let presetParams = {
            'dim': [v => (redim(parseFloat(v)), "Dimension: " + v), 2, 8, 4, 1],
            'lineWidth': [v => "Line width: " + v, 0.01, 4, 1, 0.001],
            'dist': [v => "Distance: " + v, 1, 5, 1.2, 0.001],
            'zoom': [v => "Zoom: " + v, 0, 1.5, 1, 0.001],
            'segments': [v => "Line segments: " + v, 1, 10, 3, 1],
            'rotSpeed': [v => "Rotation speed: " + v, 0, 5, 1, 0.1],
            'rotAxes': [v => "Rotation axes: " + axisname(parseFloat(v), 4), 0, 0, 1, 1]
        }
        let paramValues = {}
        Object.keys(presetParams).forEach(e => paramValues[e] = presetParams[e][3]);
        function upd(id, value, controled) {
            paramValues[id] = parseFloat(value);
            document.getElementById(id + 'Label').innerHTML = presetParams[id][0](value);
            if (!controled) {
                document.getElementById(id).value = value;
            }
        }

        let s = "";
        function repanel() {
            Object.keys(presetParams).forEach(i => {
                let e = presetParams[i];
                s += '<div class="control"><label id="' + i + 'Label" class="left" for="' + i + '">' + e[0](e[3]) + '</label>';
                s += '<input oninput="upd(' + "'" + i + "'," + 'this.value,true)" id="' + i + '"type="range" min="' + e[1] + '"" max="' + e[2] + '" value="' + e[3] + '" step="' + e[4] + '"class="slider" id="myRange"></div>';
            });
            s += '<div><label for="codeSelect">Code:</label>' +
                '<select name="codes" id = "codeSelect" >' +
                '<option value="0">Hypercube</option>' +
                '<option value="1">Axes</option>' +
                '<option value="2">Hyperball</option>' +
                '<option value="3">Hypertorus</option>' +
                '</select></div>';
            s += '<textarea rows="20" spellcheck="false" id="edit"></textarea><p id="message"></p>'

            document.getElementById("panel").innerHTML = s;
            document.getElementById("edit").value = codes[0];
            run();
        }
        repanel();
        redim(startDim);
        function log(v) {
            document.getElementById("message").style.display = 'block';
            document.getElementById("message").innerHTML = v;
        }
        function run() {
            try {
                let create = Function(document.getElementById("edit").value);
                create();
                log("");
                document.getElementById("message").style.display = 'none';
            } catch (err) {
                log("<span class='errord'>Error: </span>" + err.message);
            }

        }
        document.getElementById("codeSelect").onchange = ev => {
            document.getElementById("edit").value = codes[ev.target.value];
            run();
        }
        document.onkeydown = ev => {
            if (ev.key == "Enter" && ev.ctrlKey)
                run();
        }
    </script>
</body>

<script>
    let c = document.getElementById('c');;
    let x = c.getContext('2d');

    function resize() {
        let dw = document.body.clientWidth || 400;
        let dh = document.documentElement.clientHeight - 20 || 400; // wtf does this -20 come from?
        if (dw > dh) {
            dw = dw * 0.5 - 5;
            document.getElementById("panel").style.height = dh + "px";
            document.getElementById("panel").style.float = "right";
            document.getElementById("c").style.marginBottom = "0px";
            document.documentElement.style.overflow = 'hidden';
        } else {
            dh = dw;
            document.getElementById("panel").style.height = "auto";
            document.getElementById("panel").style.float = "left";
            document.getElementById("c").style.marginBottom = "10px";
            document.documentElement.style.overflow = 'auto';
        }
        document.getElementById("panel").style.width = dw + "px";
        c.style.width = dw + "px";
        c.style.height = dh + "px";
        c.width = c.clientWidth;
        c.height = c.clientHeight;
    }
    window.onresize = resize;
    resize();
    resize();
    let axesHandle = 0;
    function rclickListener(ev) {
        ev.preventDefault();
        return false;
    }
    c.addEventListener('contextmenu', rclickListener, false);
    c.onclick = c.ondblclick = c.onmousemove = c.onmousedown = (ev) => {
        if (document.pointerLockElement) {
            let mdim = Math.sqrt(c.width * c.width + c.height * c.height);
            let mx = ev.movementX * 0.003;
            let my = ev.movementY * 0.003;
            if (ev.buttons & 2)
                document.exitPointerLock();
            if (ev.buttons & 1) {
                if (paramValues.dim > 2) {
                    axesHandle = (axesHandle + mx * axesCombos.length) % axesCombos.length + axesCombos.length;
                    upd("rotAxes", Math.floor(axesHandle - axesCombos.length) + "");
                }
            } else {
                let ai = axesIndices[paramValues.rotAxes] || [0, 0];
                rotations[ai[0]] += mx;
                rotations[ai[1]] += my;
            }
        } else if (ev.buttons & 1)
            c.requestPointerLock();

    }
    function u(time, delta) {
        x.clearRect(0, 0, c.width, c.height);
        let scaleDim = Math.sqrt(c.width * c.width + c.height * c.height) / Math.sqrt(2);
        let mdist = paramValues.dist * 1.1 * Math.sqrt(paramValues.dim);
        let mzoom = 0.03 * (mdist ** (paramValues.zoom * paramValues.dim));

        let dd = (l) => l.map((i) => i.map((v) => v / (i[0] + mdist))).map((i) => (i.shift(), i))
        let rot = (l, t, a1, a2) => l.map((i) => i.map((v, j) => (j == a1 ? v * Math.cos(t) + i[a2] * Math.sin(t) : (j == a2 ? v * Math.cos(t) - i[a1] * Math.sin(t) : v))))

        if (!document.pointerLockElement)
            rotations = rotations.map((e, i) => e + delta * paramValues.rotSpeed * (4 / (i + 5)));

        let d = [];
        let widths = [];
        let p = points.map(e => e.slice()).slice();
        rotations.forEach((e, i) => {
            p = rot(p, e, axes[i][0], axes[i][1]);
        });

        while (p[0].length > 3)
            p = dd(p);
        if (p[0].length == 3) {
            widths = p.map((i) => 10 * paramValues.lineWidth / (i[0] + mdist))
            p = dd(p);
        } else
            widths = p.map((i) => paramValues.lineWidth);
        d = p.map((i) => (i.map((j) => j * 0.5 * mzoom)));




        let i = 0;
        while (edges[i]) {
            let ox = c.width / 2;
            let oy = c.height / 2;
            let s = paramValues.segments;
            let xb = d[edges[i][0]][0] * scaleDim + ox;
            let yb = d[edges[i][0]][1] * scaleDim + oy;
            let wb = widths[edges[i][0]];
            let xs = d[edges[i][1]][0] * scaleDim + ox - xb;
            let ys = d[edges[i][1]][1] * scaleDim + oy - yb;
            let ws = widths[edges[i][1]];
            x.beginPath()
            x.strokeStyle = 'rgb(' + edges[i][2] + ',' + edges[i][3] + ',' + edges[i][4] + ')';
            x.moveTo(xb, yb);
            while (s--) {
                sc = 1 - (s / paramValues.segments)
                x.lineWidth = wb + sc * ws;
                x.lineTo(xb + sc * xs, yb + sc * ys)
                x.stroke();

            }
            i++;
        }

    }
    let ot = (new Date()).getTime() / 1000;
    function l() {
        let t = (new Date()).getTime() / 1000;
        dt = t - ot;
        u(t, dt);
        ot = t;
        requestAnimationFrame(l);
    }
    requestAnimationFrame(l);
</script>

</html>